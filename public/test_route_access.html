<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Acesso √† Rota</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { margin: 10px 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>Teste de Acesso √† Rota de Download em Lote</h1>
    
    <div>
        <button onclick="checkAuth()">1. Verificar Autentica√ß√£o</button>
        <button onclick="testRouteAccess()">2. Testar Acesso √† Rota</button>
        <button onclick="testWithValidData()">3. Testar com Dados V√°lidos</button>
        <button onclick="clearResults()">Limpar Resultados</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        function checkAuth() {
            addResult('Verificando status de autentica√ß√£o...', 'info');
            
            fetch('/api/auth/check', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('N√£o autenticado - Status: ' + response.status);
                }
            })
            .then(data => {
                if (data.authenticated) {
                    addResult('‚úÖ Usu√°rio autenticado: ' + (data.user ? data.user.name || data.user.email : 'Usu√°rio v√°lido'), 'success');
                } else {
                    addResult('‚ùå Usu√°rio n√£o autenticado', 'error');
                }
            })
            .catch(error => {
                addResult('‚ùå Erro de autentica√ß√£o: ' + error.message, 'error');
                addResult('üí° Acesse <a href="/login" target="_blank">/login</a> para fazer login primeiro', 'info');
            });
        }
        
        function testRouteAccess() {
            addResult('Testando acesso √† rota...', 'info');
            
            // Primeiro, vamos tentar acessar a p√°gina de assets para obter o token CSRF
            fetch('/assets', {
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        addResult('‚úÖ P√°gina /assets acess√≠vel', 'success');
                        return response.text();
                    } else {
                        throw new Error('Erro ao acessar /assets: ' + response.status);
                    }
                })
                .then(html => {
                    // Extrair token CSRF
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const csrfToken = doc.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    
                    if (csrfToken) {
                        addResult('‚úÖ Token CSRF obtido: ' + csrfToken.substring(0, 10) + '...', 'success');
                        
                        // Agora testar a rota de download com dados inv√°lidos para ver a resposta
                        return fetch('/assets/download-batch', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken,
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                asset_ids: ['test-id-invalid']
                            })
                        });
                    } else {
                        throw new Error('Token CSRF n√£o encontrado na p√°gina');
                    }
                })
                .then(response => {
                    addResult('Status da rota /assets/download-batch: ' + response.status, 'info');
                    
                    if (response.status === 404) {
                        addResult('‚úÖ Rota responde (404 esperado para ID inv√°lido)', 'success');
                    } else if (response.status === 422) {
                        addResult('‚úÖ Rota responde (422 - erro de valida√ß√£o esperado)', 'success');
                    } else if (response.status === 419) {
                        addResult('‚ùå Erro 419 - Problema com token CSRF', 'error');
                    } else {
                        addResult('‚ÑπÔ∏è Status inesperado: ' + response.status, 'info');
                    }
                    
                    return response.text();
                })
                .then(data => {
                    addResult('Resposta: ' + data.substring(0, 300) + (data.length > 300 ? '...' : ''), 'info');
                })
                .catch(error => {
                    addResult('‚ùå Erro: ' + error.message, 'error');
                });
        }
        
        function testWithValidData() {
            addResult('Testando com IDs v√°lidos...', 'info');
            
            // Usar IDs v√°lidos que sabemos que existem
            const validIds = ['13e679a2-ecff-4456-9258-9a572f9fc05e', '4c2d1911-0fee-4fb6-80b3-0826c4e04e9d'];
            
            fetch('/assets', {
                credentials: 'include'
            })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const csrfToken = doc.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    
                    if (csrfToken) {
                        addResult('Token CSRF obtido para teste com IDs v√°lidos', 'info');
                        
                        return fetch('/assets/download-batch', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken,
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                asset_ids: validIds
                            })
                        });
                    } else {
                        throw new Error('Token CSRF n√£o encontrado');
                    }
                })
                .then(response => {
                    addResult('Status com IDs v√°lidos: ' + response.status, 'info');
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        addResult('‚úÖ Rota funcionando! Tipo de resposta: ' + contentType, 'success');
                        
                        if (contentType && contentType.includes('application/zip')) {
                            addResult('‚úÖ Arquivo ZIP sendo retornado corretamente!', 'success');
                        }
                    } else {
                        return response.text().then(text => {
                            addResult('‚ùå Erro na resposta: ' + text, 'error');
                        });
                    }
                })
                .catch(error => {
                    addResult('‚ùå Erro: ' + error.message, 'error');
                });
        }
    </script>
</body>
</html>